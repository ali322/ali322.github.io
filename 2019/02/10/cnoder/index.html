<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;alilab.org&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;buttons&quot;,&quot;active&quot;:&quot;disqus&quot;,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null,&quot;activeClass&quot;:&quot;disqus&quot;},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script><script src="/js/config.js"></script>
<meta name="description" content="前言之前在学会 React-Native 后写了一个 cnodejs社区的客户端 CNodeRN,前阵子了解了下 flutter, 感觉是移动应用开发的未来趋势,便有了迁移至 flutter 技术栈的想法, 然后就有了 CNoder 这个项目, 也算是对数周 flutter 的一个学习实践吧">
<meta property="og:type" content="article">
<meta property="og:title" content="Cnoder 迁移记">
<meta property="og:url" content="http://alilab.org/2019/02/10/cnoder/index.html">
<meta property="og:site_name" content="Ali Lab">
<meta property="og:description" content="前言之前在学会 React-Native 后写了一个 cnodejs社区的客户端 CNodeRN,前阵子了解了下 flutter, 感觉是移动应用开发的未来趋势,便有了迁移至 flutter 技术栈的想法, 然后就有了 CNoder 这个项目, 也算是对数周 flutter 的一个学习实践吧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://juejin.im/post/5b43187ff265da0f491b87e7">
<meta property="article:published_time" content="2019-02-10T03:13:30.000Z">
<meta property="article:modified_time" content="2022-12-06T08:13:10.450Z">
<meta property="article:author" content="Ali Chen">
<meta property="article:tag" content="Flutter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://juejin.im/post/5b43187ff265da0f491b87e7">


<link rel="canonical" href="http://alilab.org/2019/02/10/cnoder/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;alilab.org&#x2F;2019&#x2F;02&#x2F;10&#x2F;cnoder&#x2F;&quot;,&quot;path&quot;:&quot;2019&#x2F;02&#x2F;10&#x2F;cnoder&#x2F;&quot;,&quot;title&quot;:&quot;Cnoder 迁移记&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Cnoder 迁移记 | Ali Lab</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ali Lab</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">On the way of FullStack</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">安装和初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">项目目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">4.</span> <span class="nav-text">功能模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%8A%B6%E6%80%81"><span class="nav-number">5.</span> <span class="nav-text">数据状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A"><span class="nav-number">6.</span> <span class="nav-text">更多</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-1"><span class="nav-number">7.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="nav-number">8.</span> <span class="nav-text">安装和初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1"><span class="nav-number">9.</span> <span class="nav-text">项目目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97-1"><span class="nav-number">10.</span> <span class="nav-text">功能模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%8A%B6%E6%80%81-1"><span class="nav-number">11.</span> <span class="nav-text">数据状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A-1"><span class="nav-number">12.</span> <span class="nav-text">更多</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ali Chen"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Ali Chen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ali322" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ali322" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ali322@gmail.com" title="E-Mail → mailto:ali322@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/ali322" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://alilab.org/2019/02/10/cnoder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Ali Chen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ali Lab">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cnoder 迁移记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-10 11:13:30" itemprop="dateCreated datePublished" datetime="2019-02-10T11:13:30+08:00">2019-02-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-12-06 16:13:10" itemprop="dateModified" datetime="2022-12-06T16:13:10+08:00">2022-12-06</time>
      </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/02/10/cnoder/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/10/cnoder/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前在学会 React-Native 后写了一个 cnodejs社区的客户端 <a target="_blank" rel="noopener" href="https://github.com/ali322/CNodeRN">CNodeRN</a>,前阵子了解了下 flutter, 感觉是移动应用开发的未来趋势,便有了迁移至 flutter 技术栈的想法, 然后就有了 <a target="_blank" rel="noopener" href="https://github.com/ali322/cnoder">CNoder</a> 这个项目, 也算是对数周 flutter 的一个学习实践吧</p>
<span id="more"></span>

<h2 id="安装和初始化"><a href="#安装和初始化" class="headerlink" title="安装和初始化"></a>安装和初始化</h2><p>跟着官方的<a target="_blank" rel="noopener" href="https://flutter.io/setup-macos/">安装说明</a>一步一步往下走,还是挺顺利的,唯一不同的就是增加了镜像设置这一步, 打开 <code>~/.zhsrc</code>, 末尾增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">## flutter</span></span><br><span class="line">125 <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">126 <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">127 <span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/flutter/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>然后执行 <code>flutter doctor</code> 检查环境是否正常,一切顺利的话就可以初始化项目了,我使用的编辑器是 <code>vscode</code>, 通过命令窗口运行命令 <code>Flutter: New Project</code> 即可</p>
<h2 id="项目目录结构"><a href="#项目目录结构" class="headerlink" title="项目目录结构"></a>项目目录结构</h2><p>源码都位于 <code>lib</code> 目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">|-- config/</span><br><span class="line">    |-- api.dart // http api 调用接口地址配置</span><br><span class="line">|-- common/</span><br><span class="line">    |-- helper.dart // 工具函数</span><br><span class="line">|-- route/</span><br><span class="line">    |-- handler.dart // 路由配置文件</span><br><span class="line">|-- store/</span><br><span class="line">    |-- action/  // redux action 目录</span><br><span class="line">    |-- epic/   // redux_epic 配置目录</span><br><span class="line">    |-- reducer/ // redux reducer 目录</span><br><span class="line">    |-- model/ // 模型目录</span><br><span class="line">    |-- view_model/ // store 映射模型目录</span><br><span class="line">    |-- root_state.dart // 全局 state</span><br><span class="line">    |-- index.dart // store 初始入口</span><br><span class="line">|-- container/  // 连接 store 的容器目录</span><br><span class="line">|-- widget/ // 视图 widget 目录</span><br><span class="line">main.dart // 入口文件</span><br><span class="line">app.dart // 入口widget</span><br></pre></td></tr></table></figure>

<h2 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h2><ul>
<li>入口文件: main.dart, 逻辑很简单就不描述了</li>
<li>入口widget: app.dart文件</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化路由插件</span></span><br><span class="line">  <span class="keyword">final</span> Router router = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line">  App() &#123;</span><br><span class="line">    <span class="comment">// 从持久化存储里加载数据状态,这里用来存储用户的身份令牌信息</span></span><br><span class="line">    persistor.load(store);</span><br><span class="line">    <span class="comment">// 404处理</span></span><br><span class="line">    router.notFoundHandler = notFoundHandler;</span><br><span class="line">    <span class="comment">// 应用路由配置</span></span><br><span class="line">    handlers.forEach((<span class="built_in">String</span> path,Handler handler) &#123;</span><br><span class="line">      router.define(path, handler: handler);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">final</span> app = <span class="keyword">new</span> MaterialApp(</span><br><span class="line">        title: <span class="string">&#x27;CNoder&#x27;</span>,</span><br><span class="line">        <span class="comment">// 禁用右上角的 debug 标志</span></span><br><span class="line">        debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">        theme: <span class="keyword">new</span> ThemeData(</span><br><span class="line">          primarySwatch: Colors.lightGreen,</span><br><span class="line">          <span class="comment">// 定义全局图标主题</span></span><br><span class="line">          iconTheme: <span class="keyword">new</span> IconThemeData(</span><br><span class="line">            color: Color(<span class="number">0xFF666666</span>)</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">// 定义全局文本主题</span></span><br><span class="line">          textTheme: <span class="keyword">new</span> TextTheme(</span><br><span class="line">            body1: <span class="keyword">new</span> TextStyle(color: Color(<span class="number">0xFF333333</span>), fontSize: <span class="number">14.0</span>)</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 将 应用的路由映射至 fluro 的路由表里面去</span></span><br><span class="line">        onGenerateRoute: router.generator</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> StoreProvider&lt;RootState&gt;(store: store, child: app);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个坑,如果按照 fluro 提供的文档将应用路由映射至fluro的路由表,使用的方式是 <code>onGenerateRoute: router.generator</code>, 但是这样的话在路由跳转时就无法指定过渡动效了,因此需要改成这样</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onGenerateRoute: (RouteSettings routeSettings) &#123;</span><br><span class="line">  <span class="comment">// 这个方法可以在 router.generator 源码里找到,返回匹配的路由</span></span><br><span class="line">  RouteMatch match = <span class="keyword">this</span>.router.matchRoute(<span class="keyword">null</span>, routeSettings.name, routeSettings: routeSettings, transitionType: TransitionType.inFromRight);</span><br><span class="line">  <span class="keyword">return</span> match.route;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>使用 StoreProvider 容器包裹整个应用入口widget,这样才能在子节点的widget上使用StoreConnector连接store来获取数据状态和派发action</p>
<ul>
<li>接下来应用会进入路由机制,下面是部分路由配置信息</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;dart:core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:fluro/fluro.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter/material.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:cnoder/container/index.dart&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Handler&gt; handlers = &#123;</span><br><span class="line">  <span class="string">&#x27;/&#x27;</span>: <span class="keyword">new</span> Handler(</span><br><span class="line">      handlerFunc: (BuildContext context, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IndexContainer();</span><br><span class="line">  &#125;),</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>container/index.dart</code> 类似于 react 里面的 HOC,将 store 连接至子widget</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter/material.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:redux/redux.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter_redux/flutter_redux.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../store/root_state.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../store/view_model/index.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../widget/index.dart&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexContainer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> StoreConnector&lt;RootState, IndexViewModel&gt;(</span><br><span class="line">        converter: (Store&lt;RootState&gt; store) =&gt; IndexViewModel.fromStore(store),</span><br><span class="line">        builder: (BuildContext context, IndexViewModel vm) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> IndexScene(vm: vm);</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>converter 参数相当于在使用 react+redux 技术栈里面的使用 connect 函数包裹组件时的 mapAction 和 mapState 参数,将返回值作为 builder 参数对应的回调函数第二个入参 vm.</p>
<ul>
<li><code>widget/index.dart</code> 为首页的视图widget,通过底部的标签栏切换四个容器widget的显示</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">IndexScene</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 根据登陆状态切换显示</span></span><br><span class="line">  <span class="built_in">List</span> _renderScenes(<span class="built_in">bool</span> isLogined) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> isLogined = widget.vm.auth[<span class="string">&quot;isLogined&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> &lt;Widget&gt;[</span><br><span class="line">      <span class="keyword">new</span> TopicsContainer(vm: widget.vm),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> CollectContainer(vm: widget.vm) : <span class="keyword">new</span> LoginScene(),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> MessageContainer(vm: widget.vm,) : <span class="keyword">new</span> LoginScene(),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> MeContainer(vm: widget.vm,) : <span class="keyword">new</span> LoginScene()</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">bool</span> isLogined = widget.vm.auth[<span class="string">&quot;isLogined&quot;</span>];</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">List</span> scenes = _renderScenes(isLogined);</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">int</span> tabIndex = widget.vm.tabIndex;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">Function</span> setTab = widget.vm.selectTab;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">final</span> currentScene = scenes[<span class="number">0</span>];</span><br><span class="line">      <span class="comment">// 这里保证了初始化widget的服务调用</span></span><br><span class="line">      <span class="keyword">if</span> (currentScene <span class="keyword">is</span> InitializeContainer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentScene.getInitialized() == <span class="keyword">false</span>) &#123;</span><br><span class="line">          currentScene.initialize();</span><br><span class="line">          currentScene.setInitialized();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        bottomNavigationBar: <span class="keyword">new</span> CupertinoTabBar(</span><br><span class="line">          activeColor: Colors.green,</span><br><span class="line">          backgroundColor: <span class="keyword">const</span> Color(<span class="number">0xFFF7F7F7</span>),</span><br><span class="line">          currentIndex: tabIndex,</span><br><span class="line">          onTap: (<span class="built_in">int</span> i) &#123;</span><br><span class="line">            <span class="keyword">final</span> currentScene = scenes[i];</span><br><span class="line">            <span class="keyword">if</span> (isLogined) &#123;</span><br><span class="line">              <span class="comment">//  这里保证了widget的服务调用在切换时只进行一次</span></span><br><span class="line">              <span class="keyword">if</span> (currentScene <span class="keyword">is</span> InitializeContainer) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentScene.getInitialized() == <span class="keyword">false</span>) &#123;</span><br><span class="line">                  currentScene.initialize();</span><br><span class="line">                  currentScene.setInitialized();</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            setTab(i);</span><br><span class="line">          &#125;,</span><br><span class="line">          items: &lt;BottomNavigationBarItem&gt;[</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.home),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;主题&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.favorite),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;收藏&#x27;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.message),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;消息&#x27;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.person),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;我的&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 使用层叠widget来包裹视图,同一时间仅一个视图widget可见</span></span><br><span class="line">        body: <span class="keyword">new</span> IndexedStack(</span><br><span class="line">          children: scenes,</span><br><span class="line">          index: tabIndex,</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很多同学会有疑问,tabIndex 这个应该只是首页widget的内部数据状态,为何要放到 redux 里去维护?因为我们在子widget里面会去切换页签的选中状态,比如登陆完成以后切换至’我的’这个页签</p>
<ul>
<li>主题视图容器widget,在容器组件里面触发服务调用获取主题数据</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化标志位</span></span><br><span class="line"><span class="built_in">bool</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsContainer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> <span class="keyword">implements</span> <span class="title">InitializeContainer</span></span>&#123;</span><br><span class="line">  <span class="keyword">final</span> IndexViewModel vm;</span><br><span class="line"></span><br><span class="line">  TopicsContainer(&#123;Key key, <span class="meta">@required</span> <span class="keyword">this</span>.vm&#125;):<span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记已初始化,防止在首页页签切换时重复调用</span></span><br><span class="line">  <span class="keyword">void</span> setInitialized() &#123;</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取初始化状态</span></span><br><span class="line">  <span class="built_in">bool</span> getInitialized() &#123;</span><br><span class="line">    <span class="keyword">return</span> initialized;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化的操作是调用 redux action 获取主题数据</span></span><br><span class="line">  <span class="keyword">void</span> initialize() &#123;</span><br><span class="line">    vm.fetchTopics();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> StoreConnector&lt;RootState, TopicsViewModel&gt;(</span><br><span class="line">        converter: (Store&lt;RootState&gt; store) =&gt; TopicsViewModel.fromStore(store),</span><br><span class="line">        builder: (BuildContext context, TopicsViewModel vm) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> TopicsScene(vm: vm);</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主题视图widget,顶部四个页签用来切换显示四个主题分类</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TopicsScene</span>&gt; <span class="title">with</span> <span class="title">TickerProviderStateMixin</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="keyword">final</span> topicsOfCategory = widget.vm.topicsOfCategory;</span><br><span class="line"></span><br><span class="line">    _tabs = &lt;Tab&gt;[];</span><br><span class="line">    <span class="comment">// 初始化顶部页签栏</span></span><br><span class="line">    topicsOfCategory.forEach((k, v) &#123;</span><br><span class="line">      _tabs.add(<span class="keyword">new</span> Tab(</span><br><span class="line">        text: v[<span class="string">&quot;label&quot;</span>]</span><br><span class="line">      ));</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 初始化 TabBar 和 TabBarView 的控制器</span></span><br><span class="line">    _tabController  = <span class="keyword">new</span> TabController(</span><br><span class="line">      length: _tabs.length,</span><br><span class="line">      vsync: <span class="keyword">this</span> <span class="comment">// _tabController 作为属性的类必须通过 TickerProviderStateMixin 扩展</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 页签切换事件监听</span></span><br><span class="line">    _onTabChange = () &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给页签控制器增加一个事件监听器,监听页签切换事件</span></span><br><span class="line">    _tabController.addListener(_onTabChange);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    <span class="comment">// 类销毁之前移除页签控制器的事件监听</span></span><br><span class="line">    _tabController.removeListener(_onTabChange);</span><br><span class="line">    <span class="comment">// 销毁页签控制器</span></span><br><span class="line">    _tabController.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="built_in">bool</span> isLoading = widget.vm.isLoading;</span><br><span class="line">      <span class="built_in">Map</span> topicsOfCategory = widget.vm.topicsOfCategory;</span><br><span class="line">      FetchTopics fetchTopics = widget.vm.fetchTopics;</span><br><span class="line">      ResetTopics resetTopics = widget.vm.resetTopics;</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 循环显示分类下的主题列表</span></span><br><span class="line">      <span class="built_in">List</span>&lt;Widget&gt; _renderTabView() &#123;</span><br><span class="line">        <span class="keyword">final</span> _tabViews = &lt;Widget&gt;[];</span><br><span class="line">        topicsOfCategory.forEach((k, category) &#123;</span><br><span class="line">          <span class="built_in">bool</span> isFetched = topicsOfCategory[k][<span class="string">&quot;isFetched&quot;</span>];</span><br><span class="line">          <span class="comment">// 如果该分类下的主题列表未初始化先渲染一个加载指示</span></span><br><span class="line">          _tabViews.add(!isFetched ? _renderLoading(context) :</span><br><span class="line">          <span class="comment">// 使用 pull_to_refresh 包提供的下拉刷新和上来加载功能</span></span><br><span class="line">          <span class="keyword">new</span> SmartRefresher(</span><br><span class="line">            enablePullDown: <span class="keyword">true</span>,</span><br><span class="line">            enablePullUp: <span class="keyword">true</span>,</span><br><span class="line">            onRefresh: _onRefresh(k),</span><br><span class="line">            controller: _controller,</span><br><span class="line">            child: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">              physics: <span class="keyword">const</span> NeverScrollableScrollPhysics(),</span><br><span class="line">              shrinkWrap: <span class="keyword">true</span>,</span><br><span class="line">              itemCount: topicsOfCategory[k][<span class="string">&quot;list&quot;</span>].length,</span><br><span class="line">              itemBuilder: (BuildContext context, <span class="built_in">int</span> i) =&gt; _renderRow(context, topicsOfCategory[k][<span class="string">&quot;list&quot;</span>][i]),</span><br><span class="line">            ),</span><br><span class="line">          ));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> _tabViews;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 使用 ListTile 渲染列表中的每一行</span></span><br><span class="line">      Widget _renderRow(BuildContext context, Topic topic) &#123;</span><br><span class="line">      ListTile title = <span class="keyword">new</span> ListTile(</span><br><span class="line">        leading: <span class="keyword">new</span> SizedBox(</span><br><span class="line">          width: <span class="number">30.0</span>,</span><br><span class="line">          height: <span class="number">30.0</span>,</span><br><span class="line">          <span class="comment">// 使用 cached_network_image 提供支持缓存和占位图的功能显示头像</span></span><br><span class="line">          child: <span class="keyword">new</span> CachedNetworkImage(</span><br><span class="line">            imageUrl: topic.authorAvatar.startsWith(<span class="string">&#x27;//&#x27;</span>) ? <span class="string">&#x27;http:<span class="subst">$&#123;topic.authorAvatar&#125;</span>&#x27;</span> : topic.authorAvatar,</span><br><span class="line">            placeholder: <span class="keyword">new</span> Image.asset(<span class="string">&#x27;asset/image/cnoder_avatar.png&#x27;</span>),</span><br><span class="line">            errorWidget: <span class="keyword">new</span> Icon(Icons.error),</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        title: <span class="keyword">new</span> Text(topic.authorName),</span><br><span class="line">        subtitle: <span class="keyword">new</span> Row(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="keyword">new</span> Text(topic.lastReplyAt)</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        trailing: <span class="keyword">new</span> Text(<span class="string">&#x27;<span class="subst">$&#123;topic.replyCount&#125;</span>/<span class="subst">$&#123;topic.visitCount&#125;</span>&#x27;</span>),</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> InkWell(</span><br><span class="line">        <span class="comment">// 点击后跳转至主题详情</span></span><br><span class="line">        onTap: () =&gt; Navigator.of(context).pushNamed(<span class="string">&#x27;/topic/<span class="subst">$&#123;topic.id&#125;</span>&#x27;</span>),</span><br><span class="line">        child: <span class="keyword">new</span> Column(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            title,</span><br><span class="line">            <span class="keyword">new</span> Container(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">10.0</span>),</span><br><span class="line">              alignment: Alignment.centerLeft,</span><br><span class="line">              child: <span class="keyword">new</span> Text(topic.title),</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          brightness: Brightness.dark,</span><br><span class="line">          elevation: <span class="number">0.0</span>,</span><br><span class="line">          titleSpacing: <span class="number">0.0</span>,</span><br><span class="line">          bottom: <span class="keyword">null</span>,</span><br><span class="line">          <span class="comment">// 顶部显示页签栏</span></span><br><span class="line">          title: <span class="keyword">new</span> Align(</span><br><span class="line">            alignment: Alignment.bottomCenter,</span><br><span class="line">            child: <span class="keyword">new</span> TabBar(</span><br><span class="line">              labelColor: Colors.white,</span><br><span class="line">              tabs: _tabs,</span><br><span class="line">              controller: _tabController,</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 主体区域显示页签内容</span></span><br><span class="line">        body: <span class="keyword">new</span> TabBarView(</span><br><span class="line">          controller: _tabController,</span><br><span class="line">          children: _renderTabView(),</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据状态"><a href="#数据状态" class="headerlink" title="数据状态"></a>数据状态</h2><ul>
<li><code>store/view_model/topics.dart</code> 视图映射模型定义</li>
</ul>
<p>通过视图映射模型将 store 里面的 state 和 action 传递给视图widget,<br>在上面的主题容器widget里面我们通过 <code>vm.fetchTopics</code> 方法获取主题数据, 这个方法是在 TopicsViewModel 这个<br>store 映射模型里定义的</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsViewModel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Map</span> topicsOfCategory;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> isLoading;</span><br><span class="line">  <span class="keyword">final</span> FetchTopics fetchTopics;</span><br><span class="line">  <span class="keyword">final</span> ResetTopics resetTopics;</span><br><span class="line"></span><br><span class="line">  TopicsViewModel(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.topicsOfCategory, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.isLoading, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.fetchTopics, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.resetTopics</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> TopicsViewModel fromStore(Store&lt;RootState&gt; store) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TopicsViewModel(</span><br><span class="line">      <span class="comment">// 映射分类主题列表</span></span><br><span class="line">      topicsOfCategory: store.state.topicsOfCategory,</span><br><span class="line">      <span class="comment">// 映射加载状态</span></span><br><span class="line">      isLoading: store.state.isLoading,</span><br><span class="line">      <span class="comment">// 获取主题数据 action 的包装方法</span></span><br><span class="line">      fetchTopics: (&#123;<span class="built_in">int</span> currentPage = <span class="number">1</span>, <span class="built_in">String</span> category = <span class="string">&#x27;&#x27;</span>, <span class="built_in">Function</span> afterFetched = _noop&#125;) &#123;</span><br><span class="line">        <span class="comment">// 通过 isLoading 数据状态的变更来切换widget的加载指示器的显示</span></span><br><span class="line">        store.dispatch(<span class="keyword">new</span> ToggleLoading(<span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 触发获取主题数据的action,将当前页,分类名,以及调用成功的回调函数传递给action</span></span><br><span class="line">        store.dispatch(<span class="keyword">new</span> RequestTopics(currentPage: currentPage, category: category, afterFetched: afterFetched));</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 刷新主题数据的包装方法</span></span><br><span class="line">      resetTopics: (&#123;<span class="meta">@required</span> <span class="built_in">String</span> category, <span class="meta">@required</span> <span class="built_in">Function</span> afterFetched&#125;) &#123;</span><br><span class="line">        store.dispatch(<span class="keyword">new</span> RequestTopics(currentPage: <span class="number">1</span>, category: category, afterFetched: afterFetched));</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里增加了一个调用成功的回调函数给 action,是因为需要在 http 服务调用完成以后控制主题视图widget里面 SmartRefresher 这个widget 状态的切换(重置加载指示等等)</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> _onRefresh = (<span class="built_in">String</span> category) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">bool</span> up) &#123;</span><br><span class="line">      <span class="comment">// 如果是上拉加载更多</span></span><br><span class="line">      <span class="keyword">if</span> (!up) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoading) &#123;</span><br><span class="line">          _controller.sendBack(<span class="keyword">false</span>, RefreshStatus.idle);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fetchTopics(</span><br><span class="line">          currentPage: topicsOfCategory[category][<span class="string">&quot;currentPage&quot;</span>] + <span class="number">1</span>,</span><br><span class="line">          category: category,</span><br><span class="line">          afterFetched: () &#123;</span><br><span class="line">            <span class="comment">// 上拉加载更多指示器复位</span></span><br><span class="line">            _controller.sendBack(<span class="keyword">false</span>, RefreshStatus.idle);</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      <span class="comment">// 如果是下拉刷新</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resetTopics(</span><br><span class="line">          category: category,</span><br><span class="line">          afterFetched: () &#123;</span><br><span class="line">            <span class="comment">// 下拉刷新指示器复位</span></span><br><span class="line">            _controller.sendBack(<span class="keyword">true</span>, RefreshStatus.completed);</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/action/topic.dart</code> action 定义</li>
</ul>
<p>在 flutter 中以类的方式来定义 action 的,这一点与我们在 react 中使用 redux 有点不同</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送主题列表请求的 action</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestTopics</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 当前页</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</span><br><span class="line">  <span class="comment">// 分类</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> category;</span><br><span class="line">  <span class="comment">// 请求完成的回调</span></span><br><span class="line">  <span class="keyword">final</span> VoidCallback afterFetched;</span><br><span class="line"></span><br><span class="line">  RequestTopics(&#123;<span class="keyword">this</span>.currentPage = <span class="number">1</span>, <span class="keyword">this</span>.category = <span class="string">&quot;&quot;</span>, <span class="meta">@required</span> <span class="keyword">this</span>.afterFetched&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应主题列表请求的 action</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseTopics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Topic&gt; topics;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> category;</span><br><span class="line"></span><br><span class="line">  ResponseTopics(<span class="keyword">this</span>.currentPage, <span class="keyword">this</span>.category, <span class="keyword">this</span>.topics);</span><br><span class="line"></span><br><span class="line">  ResponseTopics.failed() : <span class="keyword">this</span>(<span class="number">1</span>, <span class="string">&quot;&quot;</span>, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>epic 定义,redux epic 可以看成是 action 的一个调度器,虽然 flutter 里的redux 也有 redux_thunk 中间件,但是 epic 这种基于流的调度中间件使得业务逻辑更加优雅</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;<span class="built_in">dynamic</span>&gt; fetchTopicsEpic(</span><br><span class="line">    Stream&lt;<span class="built_in">dynamic</span>&gt; actions, EpicStore&lt;RootState&gt; store) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Observable(actions)</span><br><span class="line">      <span class="comment">// 过滤特定请求</span></span><br><span class="line">      .ofType(<span class="keyword">new</span> TypeToken&lt;RequestTopics&gt;())</span><br><span class="line">      .flatMap((action) &#123;</span><br><span class="line">        <span class="comment">// 通过异步生成器来构建一个流</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Observable(() <span class="keyword">async</span>* &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发送获取主题列表的 http 请求</span></span><br><span class="line">            <span class="keyword">final</span> ret = <span class="keyword">await</span> http.<span class="keyword">get</span>(<span class="string">&quot;<span class="subst">$&#123;apis[<span class="string">&#x27;topics&#x27;</span>]&#125;</span>?page=<span class="subst">$&#123;action.currentPage&#125;</span>&amp;limit=6&amp;tab=<span class="subst">$&#123;action.category&#125;</span>&amp;mdrender=false&quot;</span>);</span><br><span class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; result = json.decode(ret.body);</span><br><span class="line">            <span class="built_in">List</span>&lt;Topic&gt; topics = [];</span><br><span class="line">            result[<span class="string">&#x27;data&#x27;</span>].forEach((v) &#123;</span><br><span class="line">              topics.add(<span class="keyword">new</span> Topic.fromJson(v));</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 触发请求完成的回调,就是我们上面提到的 SmartRefresher widget 的复位</span></span><br><span class="line">            action.afterFetched();</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">new</span> ResponseTopics(action.currentPage, action.category, topics);</span><br><span class="line">          &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="built_in">print</span>(err);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">new</span> ResponseTopicsFailed(err);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 刷新数据状态复位</span></span><br><span class="line">          <span class="keyword">yield</span> <span class="keyword">new</span> ToggleLoading(<span class="keyword">false</span>);</span><br><span class="line">        &#125; ());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在接收到请求响应后,通过 <code>Topic.fromJson</code> 这个指定类构造器来创建主题列表,这个方法定义在 <code>store/model/topic.dart</code>里面</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Topic.fromJson(<span class="keyword">final</span> <span class="built_in">Map</span> map):</span><br><span class="line">    <span class="keyword">this</span>.id = map[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.authorName = map[<span class="string">&quot;author&quot;</span>][<span class="string">&quot;loginname&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.authorAvatar = map[<span class="string">&quot;author&quot;</span>][<span class="string">&quot;avatar_url&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.title = map[<span class="string">&quot;title&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.tag = map[<span class="string">&quot;tab&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.content = map[<span class="string">&quot;content&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.createdAt = fromNow(map[<span class="string">&quot;create_at&quot;</span>]),</span><br><span class="line">    <span class="keyword">this</span>.lastReplyAt = fromNow(map[<span class="string">&quot;last_reply_at&quot;</span>]),</span><br><span class="line">    <span class="keyword">this</span>.replyCount = map[<span class="string">&quot;reply_count&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.visitCount = map[<span class="string">&quot;visit_count&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.top = map[<span class="string">&quot;top&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.isCollect = map[<span class="string">&quot;is_collect&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.replies = formatedReplies(map[<span class="string">&#x27;replies&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/reducer/topic.dart</code>, 通过主题列表的 reducer 来变更 store 里面的数据状态</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Reducer&lt;<span class="built_in">Map</span>&gt; topicsReducer = combineReducers([</span><br><span class="line">  <span class="comment">// 通过指定 action 类型来拆分</span></span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, ClearTopic&gt;(_clearTopic),</span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, RequestTopics&gt;(_requestTopics),</span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, ResponseTopics&gt;(_responseTopics)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空主题列表</span></span><br><span class="line"><span class="built_in">Map</span> _clearTopic(<span class="built_in">Map</span> state, ClearTopic action) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span> _requestTopics(<span class="built_in">Map</span> state, RequestTopics action) &#123;</span><br><span class="line">  <span class="built_in">Map</span> topicsOfTopics = &#123;&#125;;</span><br><span class="line">  state.forEach((k, v) &#123;</span><br><span class="line">    <span class="keyword">final</span> _v = <span class="keyword">new</span> <span class="built_in">Map</span>.from(v);</span><br><span class="line">    <span class="keyword">if</span> (action.category == k) &#123;</span><br><span class="line">      <span class="comment">// 通过 isFetched 标志位来防止分类页面切换时重复请求</span></span><br><span class="line">      _v[<span class="string">&quot;isFetched&quot;</span>] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    topicsOfTopics[k] = _v;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> topicsOfTopics;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span> _responseTopics(<span class="built_in">Map</span> state, ResponseTopics action) &#123;</span><br><span class="line">  <span class="built_in">Map</span> topicsOfCategory = &#123;&#125;;</span><br><span class="line">  state.forEach((k, v) &#123;</span><br><span class="line">    <span class="built_in">Map</span> _v = &#123;&#125;;</span><br><span class="line">    _v.addAll(v);</span><br><span class="line">    <span class="keyword">if</span> (k == action.category) &#123;</span><br><span class="line">      <span class="built_in">List</span> _list = [];</span><br><span class="line">      <span class="comment">// 上拉加载更多时</span></span><br><span class="line">      <span class="keyword">if</span> (_v[<span class="string">&#x27;currentPage&#x27;</span>] &lt; action.currentPage) &#123;</span><br><span class="line">        _list.addAll(_v[<span class="string">&quot;list&quot;</span>]);</span><br><span class="line">        _list.addAll(action.topics);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">// 下拉刷新时</span></span><br><span class="line">      <span class="keyword">if</span> (action.currentPage == <span class="number">1</span>) &#123;</span><br><span class="line">        _list.addAll(action.topics);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 通过 isFetched 标志位来防止分类页面切换时重复请求</span></span><br><span class="line">      _v[<span class="string">&quot;isFetched&quot;</span>] = <span class="keyword">true</span>;</span><br><span class="line">      _v[<span class="string">&quot;list&quot;</span>] = _list;</span><br><span class="line">      _v[<span class="string">&quot;currentPage&quot;</span>] = action.currentPage;</span><br><span class="line">    &#125;</span><br><span class="line">    topicsOfCategory[k] = _v;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> topicsOfCategory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>store/reducer/root.dart</code> 的 rootReducer 里进行合并</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RootState rootReducer(RootState state, action) &#123;</span><br><span class="line">  <span class="comment">// 处理从持久化存储里加载数据状态</span></span><br><span class="line">  <span class="keyword">if</span> (action <span class="keyword">is</span> PersistLoadedAction&lt;RootState&gt;) &#123;</span><br><span class="line">    <span class="keyword">return</span> action.state ?? state;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 state 里的数据状态对应到子 reducer</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RootState(</span><br><span class="line">    tabIndex: tabReducer(state.tabIndex, action),</span><br><span class="line">    auth:  loginReducer(state.auth, action),</span><br><span class="line">    isLoading: loadingReducer(state.isLoading, action),</span><br><span class="line">    topicsOfCategory: topicsReducer(state.topicsOfCategory, action),</span><br><span class="line">    topic: topicReducer(state.topic, action),</span><br><span class="line">    me: meReducer(state.me, action),</span><br><span class="line">    collects: collectsReducer(state.collects, action),</span><br><span class="line">    messages: messagesReducer(state.messages, action)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/index.dart</code> store 的初始化入口,在我们上面的入口widget里面使用 <code>StoreProvider</code> 容器包裹的时候传递</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并 epic 获得根 epic 提供给 epic 中间件调用</span></span><br><span class="line"><span class="keyword">final</span> epic = combineEpics([</span><br><span class="line">  doLoginEpic, </span><br><span class="line">  fetchTopicsEpic, fetchTopicEpic, </span><br><span class="line">  fetchMeEpic,</span><br><span class="line">  fetchCollectsEpic,</span><br><span class="line">  fetchMessagesEpic,</span><br><span class="line">  fetchMessageCountEpic,</span><br><span class="line">  markAllAsReadEpic,</span><br><span class="line">  markAsReadEpic,</span><br><span class="line">  createReplyEpic,</span><br><span class="line">  saveTopicEpic,</span><br><span class="line">  createTopicEpic,</span><br><span class="line">  toggleCollectEpic,</span><br><span class="line">  likeReplyEpic,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化持久化中间件存储容器</span></span><br><span class="line"><span class="keyword">final</span> persistor = Persistor&lt;RootState&gt;(</span><br><span class="line">  storage: FlutterStorage(<span class="string">&#x27;cnoder&#x27;</span>),</span><br><span class="line">  decoder: RootState.fromJson,</span><br><span class="line">  debug: <span class="keyword">true</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 store</span></span><br><span class="line"><span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;RootState&gt;(rootReducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> RootState(), middleware: [</span><br><span class="line">    <span class="keyword">new</span> LoggingMiddleware.printer(), </span><br><span class="line">    <span class="keyword">new</span> EpicMiddleware(epic),</span><br><span class="line">    persistor.createMiddleware()</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>这里有个小坑,持久化存储中间件 redux_persist 的文档上加载中间件的方式为</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> store = <span class="keyword">new</span> Store&lt;AppState&gt;(</span><br><span class="line">  reducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> AppState(),</span><br><span class="line">  middleware: [persistor.createMiddleware()],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>但是这样处理的话,在每个业务 action 触发的时候,都会触发持久化的操作,而这在很多场景下是不必要的,比如在我们的应用中只需要保存的用户身份令牌,所以只需要在触发登陆和登出 action 的时候执行持久化的操作,因此加载中间件的方式需要做如下改动</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> persistMiddleware(Store store, <span class="built_in">dynamic</span> action, NextDispatcher next) &#123;</span><br><span class="line">  next(action);</span><br><span class="line">  <span class="comment">// 仅处理登陆和登出操作</span></span><br><span class="line">  <span class="keyword">if</span> (action <span class="keyword">is</span> FinishLogin || action <span class="keyword">is</span> Logout) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      persistor.save(store);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 store</span></span><br><span class="line"><span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;RootState&gt;(rootReducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> RootState(), middleware: [</span><br><span class="line">    <span class="keyword">new</span> LoggingMiddleware.printer(), </span><br><span class="line">    <span class="keyword">new</span> EpicMiddleware(epic),</span><br><span class="line">    persistMiddleware</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h2 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h2><p>应用的视图层和数据状态处理还是跟使用 React-Native 开发中使用 redux 技术栈的方式差不多,虽然整体目录结构有点繁琐,但是业务逻辑清晰明了,在后续功能扩展和维护的时候还是带来不少的方便,唯一遗憾的是因为 flutter 系统架构的问题,还没有一个针对 flutter 的 redux devtools,这一点还是蛮影响开发效率的</p>
<p>完整的项目源码请关注github仓库: <a target="_blank" rel="noopener" href="https://github.com/ali322/cnoder">cnoder</a>,欢迎 star 和 PR,对 flutter 理解的不深,还望各位对本文中的不足之处批评指正</p>
<p><strong><img src="https://juejin.im/post/5b43187ff265da0f491b87e7" alt="从 0 到 1：我的 Flutter 技术实践 | 掘金技术征文，征文活动整在进行中"></strong></p>
<h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>之前在学会 React-Native 后写了一个 cnodejs社区的客户端 <a target="_blank" rel="noopener" href="https://github.com/ali322/CNodeRN">CNodeRN</a>,前阵子了解了下 flutter, 感觉是移动应用开发的未来趋势,便有了迁移至 flutter 技术栈的想法, 然后就有了 <a target="_blank" rel="noopener" href="https://github.com/ali322/cnoder">CNoder</a> 这个项目, 也算是对数周 flutter 的一个学习实践吧</p>
<h2 id="安装和初始化-1"><a href="#安装和初始化-1" class="headerlink" title="安装和初始化"></a>安装和初始化</h2><p>跟着官方的<a target="_blank" rel="noopener" href="https://flutter.io/setup-macos/">安装说明</a>一步一步往下走,还是挺顺利的,唯一不同的就是增加了镜像设置这一步, 打开 <code>~/.zhsrc</code>, 末尾增加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">## flutter</span></span><br><span class="line">125 <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">126 <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">127 <span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/flutter/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>然后执行 <code>flutter doctor</code> 检查环境是否正常,一切顺利的话就可以初始化项目了,我使用的编辑器是 <code>vscode</code>, 通过命令窗口运行命令 <code>Flutter: New Project</code> 即可</p>
<h2 id="项目目录结构-1"><a href="#项目目录结构-1" class="headerlink" title="项目目录结构"></a>项目目录结构</h2><p>源码都位于 <code>lib</code> 目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">|-- config/</span><br><span class="line">    |-- api.dart // http api 调用接口地址配置</span><br><span class="line">|-- common/</span><br><span class="line">    |-- helper.dart // 工具函数</span><br><span class="line">|-- route/</span><br><span class="line">    |-- handler.dart // 路由配置文件</span><br><span class="line">|-- store/</span><br><span class="line">    |-- action/  // redux action 目录</span><br><span class="line">    |-- epic/   // redux_epic 配置目录</span><br><span class="line">    |-- reducer/ // redux reducer 目录</span><br><span class="line">    |-- model/ // 模型目录</span><br><span class="line">    |-- view_model/ // store 映射模型目录</span><br><span class="line">    |-- root_state.dart // 全局 state</span><br><span class="line">    |-- index.dart // store 初始入口</span><br><span class="line">|-- container/  // 连接 store 的容器目录</span><br><span class="line">|-- widget/ // 视图 widget 目录</span><br><span class="line">main.dart // 入口文件</span><br><span class="line">app.dart // 入口widget</span><br></pre></td></tr></table></figure>

<h2 id="功能模块-1"><a href="#功能模块-1" class="headerlink" title="功能模块"></a>功能模块</h2><ul>
<li>入口文件: main.dart, 逻辑很简单就不描述了</li>
<li>入口widget: app.dart文件</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化路由插件</span></span><br><span class="line">  <span class="keyword">final</span> Router router = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line">  App() &#123;</span><br><span class="line">    <span class="comment">// 从持久化存储里加载数据状态,这里用来存储用户的身份令牌信息</span></span><br><span class="line">    persistor.load(store);</span><br><span class="line">    <span class="comment">// 404处理</span></span><br><span class="line">    router.notFoundHandler = notFoundHandler;</span><br><span class="line">    <span class="comment">// 应用路由配置</span></span><br><span class="line">    handlers.forEach((<span class="built_in">String</span> path,Handler handler) &#123;</span><br><span class="line">      router.define(path, handler: handler);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">final</span> app = <span class="keyword">new</span> MaterialApp(</span><br><span class="line">        title: <span class="string">&#x27;CNoder&#x27;</span>,</span><br><span class="line">        <span class="comment">// 禁用右上角的 debug 标志</span></span><br><span class="line">        debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">        theme: <span class="keyword">new</span> ThemeData(</span><br><span class="line">          primarySwatch: Colors.lightGreen,</span><br><span class="line">          <span class="comment">// 定义全局图标主题</span></span><br><span class="line">          iconTheme: <span class="keyword">new</span> IconThemeData(</span><br><span class="line">            color: Color(<span class="number">0xFF666666</span>)</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">// 定义全局文本主题</span></span><br><span class="line">          textTheme: <span class="keyword">new</span> TextTheme(</span><br><span class="line">            body1: <span class="keyword">new</span> TextStyle(color: Color(<span class="number">0xFF333333</span>), fontSize: <span class="number">14.0</span>)</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 将 应用的路由映射至 fluro 的路由表里面去</span></span><br><span class="line">        onGenerateRoute: router.generator</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> StoreProvider&lt;RootState&gt;(store: store, child: app);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个坑,如果按照 fluro 提供的文档将应用路由映射至fluro的路由表,使用的方式是 <code>onGenerateRoute: router.generator</code>, 但是这样的话在路由跳转时就无法指定过渡动效了,因此需要改成这样</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onGenerateRoute: (RouteSettings routeSettings) &#123;</span><br><span class="line">  <span class="comment">// 这个方法可以在 router.generator 源码里找到,返回匹配的路由</span></span><br><span class="line">  RouteMatch match = <span class="keyword">this</span>.router.matchRoute(<span class="keyword">null</span>, routeSettings.name, routeSettings: routeSettings, transitionType: TransitionType.inFromRight);</span><br><span class="line">  <span class="keyword">return</span> match.route;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>使用 StoreProvider 容器包裹整个应用入口widget,这样才能在子节点的widget上使用StoreConnector连接store来获取数据状态和派发action</p>
<ul>
<li>接下来应用会进入路由机制,下面是部分路由配置信息</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;dart:core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:fluro/fluro.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter/material.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:cnoder/container/index.dart&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Handler&gt; handlers = &#123;</span><br><span class="line">  <span class="string">&#x27;/&#x27;</span>: <span class="keyword">new</span> Handler(</span><br><span class="line">      handlerFunc: (BuildContext context, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; params) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IndexContainer();</span><br><span class="line">  &#125;),</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>container/index.dart</code> 类似于 react 里面的 HOC,将 store 连接至子widget</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter/material.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:redux/redux.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;package:flutter_redux/flutter_redux.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../store/root_state.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../store/view_model/index.dart&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../widget/index.dart&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexContainer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> StoreConnector&lt;RootState, IndexViewModel&gt;(</span><br><span class="line">        converter: (Store&lt;RootState&gt; store) =&gt; IndexViewModel.fromStore(store),</span><br><span class="line">        builder: (BuildContext context, IndexViewModel vm) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> IndexScene(vm: vm);</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>converter 参数相当于在使用 react+redux 技术栈里面的使用 connect 函数包裹组件时的 mapAction 和 mapState 参数,将返回值作为 builder 参数对应的回调函数第二个入参 vm.</p>
<ul>
<li><code>widget/index.dart</code> 为首页的视图widget,通过底部的标签栏切换四个容器widget的显示</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">IndexScene</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 根据登陆状态切换显示</span></span><br><span class="line">  <span class="built_in">List</span> _renderScenes(<span class="built_in">bool</span> isLogined) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> isLogined = widget.vm.auth[<span class="string">&quot;isLogined&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> &lt;Widget&gt;[</span><br><span class="line">      <span class="keyword">new</span> TopicsContainer(vm: widget.vm),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> CollectContainer(vm: widget.vm) : <span class="keyword">new</span> LoginScene(),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> MessageContainer(vm: widget.vm,) : <span class="keyword">new</span> LoginScene(),</span><br><span class="line">      isLogined ? <span class="keyword">new</span> MeContainer(vm: widget.vm,) : <span class="keyword">new</span> LoginScene()</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">bool</span> isLogined = widget.vm.auth[<span class="string">&quot;isLogined&quot;</span>];</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">List</span> scenes = _renderScenes(isLogined);</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">int</span> tabIndex = widget.vm.tabIndex;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">Function</span> setTab = widget.vm.selectTab;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">final</span> currentScene = scenes[<span class="number">0</span>];</span><br><span class="line">      <span class="comment">// 这里保证了初始化widget的服务调用</span></span><br><span class="line">      <span class="keyword">if</span> (currentScene <span class="keyword">is</span> InitializeContainer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentScene.getInitialized() == <span class="keyword">false</span>) &#123;</span><br><span class="line">          currentScene.initialize();</span><br><span class="line">          currentScene.setInitialized();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        bottomNavigationBar: <span class="keyword">new</span> CupertinoTabBar(</span><br><span class="line">          activeColor: Colors.green,</span><br><span class="line">          backgroundColor: <span class="keyword">const</span> Color(<span class="number">0xFFF7F7F7</span>),</span><br><span class="line">          currentIndex: tabIndex,</span><br><span class="line">          onTap: (<span class="built_in">int</span> i) &#123;</span><br><span class="line">            <span class="keyword">final</span> currentScene = scenes[i];</span><br><span class="line">            <span class="keyword">if</span> (isLogined) &#123;</span><br><span class="line">              <span class="comment">//  这里保证了widget的服务调用在切换时只进行一次</span></span><br><span class="line">              <span class="keyword">if</span> (currentScene <span class="keyword">is</span> InitializeContainer) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentScene.getInitialized() == <span class="keyword">false</span>) &#123;</span><br><span class="line">                  currentScene.initialize();</span><br><span class="line">                  currentScene.setInitialized();</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            setTab(i);</span><br><span class="line">          &#125;,</span><br><span class="line">          items: &lt;BottomNavigationBarItem&gt;[</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.home),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;主题&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.favorite),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;收藏&#x27;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.message),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;消息&#x27;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> BottomNavigationBarItem(</span><br><span class="line">              icon: <span class="keyword">new</span> Icon(Icons.person),</span><br><span class="line">              title: <span class="keyword">new</span> Text(<span class="string">&#x27;我的&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 使用层叠widget来包裹视图,同一时间仅一个视图widget可见</span></span><br><span class="line">        body: <span class="keyword">new</span> IndexedStack(</span><br><span class="line">          children: scenes,</span><br><span class="line">          index: tabIndex,</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很多同学会有疑问,tabIndex 这个应该只是首页widget的内部数据状态,为何要放到 redux 里去维护?因为我们在子widget里面会去切换页签的选中状态,比如登陆完成以后切换至’我的’这个页签</p>
<ul>
<li>主题视图容器widget,在容器组件里面触发服务调用获取主题数据</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化标志位</span></span><br><span class="line"><span class="built_in">bool</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsContainer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> <span class="keyword">implements</span> <span class="title">InitializeContainer</span></span>&#123;</span><br><span class="line">  <span class="keyword">final</span> IndexViewModel vm;</span><br><span class="line"></span><br><span class="line">  TopicsContainer(&#123;Key key, <span class="meta">@required</span> <span class="keyword">this</span>.vm&#125;):<span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记已初始化,防止在首页页签切换时重复调用</span></span><br><span class="line">  <span class="keyword">void</span> setInitialized() &#123;</span><br><span class="line">    initialized = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取初始化状态</span></span><br><span class="line">  <span class="built_in">bool</span> getInitialized() &#123;</span><br><span class="line">    <span class="keyword">return</span> initialized;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化的操作是调用 redux action 获取主题数据</span></span><br><span class="line">  <span class="keyword">void</span> initialize() &#123;</span><br><span class="line">    vm.fetchTopics();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> StoreConnector&lt;RootState, TopicsViewModel&gt;(</span><br><span class="line">        converter: (Store&lt;RootState&gt; store) =&gt; TopicsViewModel.fromStore(store),</span><br><span class="line">        builder: (BuildContext context, TopicsViewModel vm) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> TopicsScene(vm: vm);</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主题视图widget,顶部四个页签用来切换显示四个主题分类</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TopicsScene</span>&gt; <span class="title">with</span> <span class="title">TickerProviderStateMixin</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="keyword">final</span> topicsOfCategory = widget.vm.topicsOfCategory;</span><br><span class="line"></span><br><span class="line">    _tabs = &lt;Tab&gt;[];</span><br><span class="line">    <span class="comment">// 初始化顶部页签栏</span></span><br><span class="line">    topicsOfCategory.forEach((k, v) &#123;</span><br><span class="line">      _tabs.add(<span class="keyword">new</span> Tab(</span><br><span class="line">        text: v[<span class="string">&quot;label&quot;</span>]</span><br><span class="line">      ));</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 初始化 TabBar 和 TabBarView 的控制器</span></span><br><span class="line">    _tabController  = <span class="keyword">new</span> TabController(</span><br><span class="line">      length: _tabs.length,</span><br><span class="line">      vsync: <span class="keyword">this</span> <span class="comment">// _tabController 作为属性的类必须通过 TickerProviderStateMixin 扩展</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 页签切换事件监听</span></span><br><span class="line">    _onTabChange = () &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给页签控制器增加一个事件监听器,监听页签切换事件</span></span><br><span class="line">    _tabController.addListener(_onTabChange);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    <span class="comment">// 类销毁之前移除页签控制器的事件监听</span></span><br><span class="line">    _tabController.removeListener(_onTabChange);</span><br><span class="line">    <span class="comment">// 销毁页签控制器</span></span><br><span class="line">    _tabController.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">    Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="built_in">bool</span> isLoading = widget.vm.isLoading;</span><br><span class="line">      <span class="built_in">Map</span> topicsOfCategory = widget.vm.topicsOfCategory;</span><br><span class="line">      FetchTopics fetchTopics = widget.vm.fetchTopics;</span><br><span class="line">      ResetTopics resetTopics = widget.vm.resetTopics;</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 循环显示分类下的主题列表</span></span><br><span class="line">      <span class="built_in">List</span>&lt;Widget&gt; _renderTabView() &#123;</span><br><span class="line">        <span class="keyword">final</span> _tabViews = &lt;Widget&gt;[];</span><br><span class="line">        topicsOfCategory.forEach((k, category) &#123;</span><br><span class="line">          <span class="built_in">bool</span> isFetched = topicsOfCategory[k][<span class="string">&quot;isFetched&quot;</span>];</span><br><span class="line">          <span class="comment">// 如果该分类下的主题列表未初始化先渲染一个加载指示</span></span><br><span class="line">          _tabViews.add(!isFetched ? _renderLoading(context) :</span><br><span class="line">          <span class="comment">// 使用 pull_to_refresh 包提供的下拉刷新和上来加载功能</span></span><br><span class="line">          <span class="keyword">new</span> SmartRefresher(</span><br><span class="line">            enablePullDown: <span class="keyword">true</span>,</span><br><span class="line">            enablePullUp: <span class="keyword">true</span>,</span><br><span class="line">            onRefresh: _onRefresh(k),</span><br><span class="line">            controller: _controller,</span><br><span class="line">            child: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">              physics: <span class="keyword">const</span> NeverScrollableScrollPhysics(),</span><br><span class="line">              shrinkWrap: <span class="keyword">true</span>,</span><br><span class="line">              itemCount: topicsOfCategory[k][<span class="string">&quot;list&quot;</span>].length,</span><br><span class="line">              itemBuilder: (BuildContext context, <span class="built_in">int</span> i) =&gt; _renderRow(context, topicsOfCategory[k][<span class="string">&quot;list&quot;</span>][i]),</span><br><span class="line">            ),</span><br><span class="line">          ));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> _tabViews;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 使用 ListTile 渲染列表中的每一行</span></span><br><span class="line">      Widget _renderRow(BuildContext context, Topic topic) &#123;</span><br><span class="line">      ListTile title = <span class="keyword">new</span> ListTile(</span><br><span class="line">        leading: <span class="keyword">new</span> SizedBox(</span><br><span class="line">          width: <span class="number">30.0</span>,</span><br><span class="line">          height: <span class="number">30.0</span>,</span><br><span class="line">          <span class="comment">// 使用 cached_network_image 提供支持缓存和占位图的功能显示头像</span></span><br><span class="line">          child: <span class="keyword">new</span> CachedNetworkImage(</span><br><span class="line">            imageUrl: topic.authorAvatar.startsWith(<span class="string">&#x27;//&#x27;</span>) ? <span class="string">&#x27;http:<span class="subst">$&#123;topic.authorAvatar&#125;</span>&#x27;</span> : topic.authorAvatar,</span><br><span class="line">            placeholder: <span class="keyword">new</span> Image.asset(<span class="string">&#x27;asset/image/cnoder_avatar.png&#x27;</span>),</span><br><span class="line">            errorWidget: <span class="keyword">new</span> Icon(Icons.error),</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        title: <span class="keyword">new</span> Text(topic.authorName),</span><br><span class="line">        subtitle: <span class="keyword">new</span> Row(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="keyword">new</span> Text(topic.lastReplyAt)</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        trailing: <span class="keyword">new</span> Text(<span class="string">&#x27;<span class="subst">$&#123;topic.replyCount&#125;</span>/<span class="subst">$&#123;topic.visitCount&#125;</span>&#x27;</span>),</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> InkWell(</span><br><span class="line">        <span class="comment">// 点击后跳转至主题详情</span></span><br><span class="line">        onTap: () =&gt; Navigator.of(context).pushNamed(<span class="string">&#x27;/topic/<span class="subst">$&#123;topic.id&#125;</span>&#x27;</span>),</span><br><span class="line">        child: <span class="keyword">new</span> Column(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            title,</span><br><span class="line">            <span class="keyword">new</span> Container(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">10.0</span>),</span><br><span class="line">              alignment: Alignment.centerLeft,</span><br><span class="line">              child: <span class="keyword">new</span> Text(topic.title),</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          brightness: Brightness.dark,</span><br><span class="line">          elevation: <span class="number">0.0</span>,</span><br><span class="line">          titleSpacing: <span class="number">0.0</span>,</span><br><span class="line">          bottom: <span class="keyword">null</span>,</span><br><span class="line">          <span class="comment">// 顶部显示页签栏</span></span><br><span class="line">          title: <span class="keyword">new</span> Align(</span><br><span class="line">            alignment: Alignment.bottomCenter,</span><br><span class="line">            child: <span class="keyword">new</span> TabBar(</span><br><span class="line">              labelColor: Colors.white,</span><br><span class="line">              tabs: _tabs,</span><br><span class="line">              controller: _tabController,</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 主体区域显示页签内容</span></span><br><span class="line">        body: <span class="keyword">new</span> TabBarView(</span><br><span class="line">          controller: _tabController,</span><br><span class="line">          children: _renderTabView(),</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据状态-1"><a href="#数据状态-1" class="headerlink" title="数据状态"></a>数据状态</h2><ul>
<li><code>store/view_model/topics.dart</code> 视图映射模型定义</li>
</ul>
<p>通过视图映射模型将 store 里面的 state 和 action 传递给视图widget,<br>在上面的主题容器widget里面我们通过 <code>vm.fetchTopics</code> 方法获取主题数据, 这个方法是在 TopicsViewModel 这个<br>store 映射模型里定义的</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicsViewModel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Map</span> topicsOfCategory;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> isLoading;</span><br><span class="line">  <span class="keyword">final</span> FetchTopics fetchTopics;</span><br><span class="line">  <span class="keyword">final</span> ResetTopics resetTopics;</span><br><span class="line"></span><br><span class="line">  TopicsViewModel(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.topicsOfCategory, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.isLoading, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.fetchTopics, </span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.resetTopics</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> TopicsViewModel fromStore(Store&lt;RootState&gt; store) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TopicsViewModel(</span><br><span class="line">      <span class="comment">// 映射分类主题列表</span></span><br><span class="line">      topicsOfCategory: store.state.topicsOfCategory,</span><br><span class="line">      <span class="comment">// 映射加载状态</span></span><br><span class="line">      isLoading: store.state.isLoading,</span><br><span class="line">      <span class="comment">// 获取主题数据 action 的包装方法</span></span><br><span class="line">      fetchTopics: (&#123;<span class="built_in">int</span> currentPage = <span class="number">1</span>, <span class="built_in">String</span> category = <span class="string">&#x27;&#x27;</span>, <span class="built_in">Function</span> afterFetched = _noop&#125;) &#123;</span><br><span class="line">        <span class="comment">// 通过 isLoading 数据状态的变更来切换widget的加载指示器的显示</span></span><br><span class="line">        store.dispatch(<span class="keyword">new</span> ToggleLoading(<span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 触发获取主题数据的action,将当前页,分类名,以及调用成功的回调函数传递给action</span></span><br><span class="line">        store.dispatch(<span class="keyword">new</span> RequestTopics(currentPage: currentPage, category: category, afterFetched: afterFetched));</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 刷新主题数据的包装方法</span></span><br><span class="line">      resetTopics: (&#123;<span class="meta">@required</span> <span class="built_in">String</span> category, <span class="meta">@required</span> <span class="built_in">Function</span> afterFetched&#125;) &#123;</span><br><span class="line">        store.dispatch(<span class="keyword">new</span> RequestTopics(currentPage: <span class="number">1</span>, category: category, afterFetched: afterFetched));</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里增加了一个调用成功的回调函数给 action,是因为需要在 http 服务调用完成以后控制主题视图widget里面 SmartRefresher 这个widget 状态的切换(重置加载指示等等)</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> _onRefresh = (<span class="built_in">String</span> category) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">bool</span> up) &#123;</span><br><span class="line">      <span class="comment">// 如果是上拉加载更多</span></span><br><span class="line">      <span class="keyword">if</span> (!up) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoading) &#123;</span><br><span class="line">          _controller.sendBack(<span class="keyword">false</span>, RefreshStatus.idle);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fetchTopics(</span><br><span class="line">          currentPage: topicsOfCategory[category][<span class="string">&quot;currentPage&quot;</span>] + <span class="number">1</span>,</span><br><span class="line">          category: category,</span><br><span class="line">          afterFetched: () &#123;</span><br><span class="line">            <span class="comment">// 上拉加载更多指示器复位</span></span><br><span class="line">            _controller.sendBack(<span class="keyword">false</span>, RefreshStatus.idle);</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      <span class="comment">// 如果是下拉刷新</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resetTopics(</span><br><span class="line">          category: category,</span><br><span class="line">          afterFetched: () &#123;</span><br><span class="line">            <span class="comment">// 下拉刷新指示器复位</span></span><br><span class="line">            _controller.sendBack(<span class="keyword">true</span>, RefreshStatus.completed);</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/action/topic.dart</code> action 定义</li>
</ul>
<p>在 flutter 中以类的方式来定义 action 的,这一点与我们在 react 中使用 redux 有点不同</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送主题列表请求的 action</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestTopics</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 当前页</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</span><br><span class="line">  <span class="comment">// 分类</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> category;</span><br><span class="line">  <span class="comment">// 请求完成的回调</span></span><br><span class="line">  <span class="keyword">final</span> VoidCallback afterFetched;</span><br><span class="line"></span><br><span class="line">  RequestTopics(&#123;<span class="keyword">this</span>.currentPage = <span class="number">1</span>, <span class="keyword">this</span>.category = <span class="string">&quot;&quot;</span>, <span class="meta">@required</span> <span class="keyword">this</span>.afterFetched&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应主题列表请求的 action</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseTopics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Topic&gt; topics;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> currentPage;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> category;</span><br><span class="line"></span><br><span class="line">  ResponseTopics(<span class="keyword">this</span>.currentPage, <span class="keyword">this</span>.category, <span class="keyword">this</span>.topics);</span><br><span class="line"></span><br><span class="line">  ResponseTopics.failed() : <span class="keyword">this</span>(<span class="number">1</span>, <span class="string">&quot;&quot;</span>, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>epic 定义,redux epic 可以看成是 action 的一个调度器,虽然 flutter 里的redux 也有 redux_thunk 中间件,但是 epic 这种基于流的调度中间件使得业务逻辑更加优雅</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;<span class="built_in">dynamic</span>&gt; fetchTopicsEpic(</span><br><span class="line">    Stream&lt;<span class="built_in">dynamic</span>&gt; actions, EpicStore&lt;RootState&gt; store) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Observable(actions)</span><br><span class="line">      <span class="comment">// 过滤特定请求</span></span><br><span class="line">      .ofType(<span class="keyword">new</span> TypeToken&lt;RequestTopics&gt;())</span><br><span class="line">      .flatMap((action) &#123;</span><br><span class="line">        <span class="comment">// 通过异步生成器来构建一个流</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Observable(() <span class="keyword">async</span>* &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发送获取主题列表的 http 请求</span></span><br><span class="line">            <span class="keyword">final</span> ret = <span class="keyword">await</span> http.<span class="keyword">get</span>(<span class="string">&quot;<span class="subst">$&#123;apis[<span class="string">&#x27;topics&#x27;</span>]&#125;</span>?page=<span class="subst">$&#123;action.currentPage&#125;</span>&amp;limit=6&amp;tab=<span class="subst">$&#123;action.category&#125;</span>&amp;mdrender=false&quot;</span>);</span><br><span class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; result = json.decode(ret.body);</span><br><span class="line">            <span class="built_in">List</span>&lt;Topic&gt; topics = [];</span><br><span class="line">            result[<span class="string">&#x27;data&#x27;</span>].forEach((v) &#123;</span><br><span class="line">              topics.add(<span class="keyword">new</span> Topic.fromJson(v));</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 触发请求完成的回调,就是我们上面提到的 SmartRefresher widget 的复位</span></span><br><span class="line">            action.afterFetched();</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">new</span> ResponseTopics(action.currentPage, action.category, topics);</span><br><span class="line">          &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="built_in">print</span>(err);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">new</span> ResponseTopicsFailed(err);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 刷新数据状态复位</span></span><br><span class="line">          <span class="keyword">yield</span> <span class="keyword">new</span> ToggleLoading(<span class="keyword">false</span>);</span><br><span class="line">        &#125; ());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在接收到请求响应后,通过 <code>Topic.fromJson</code> 这个指定类构造器来创建主题列表,这个方法定义在 <code>store/model/topic.dart</code>里面</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Topic.fromJson(<span class="keyword">final</span> <span class="built_in">Map</span> map):</span><br><span class="line">    <span class="keyword">this</span>.id = map[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.authorName = map[<span class="string">&quot;author&quot;</span>][<span class="string">&quot;loginname&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.authorAvatar = map[<span class="string">&quot;author&quot;</span>][<span class="string">&quot;avatar_url&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.title = map[<span class="string">&quot;title&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.tag = map[<span class="string">&quot;tab&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.content = map[<span class="string">&quot;content&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.createdAt = fromNow(map[<span class="string">&quot;create_at&quot;</span>]),</span><br><span class="line">    <span class="keyword">this</span>.lastReplyAt = fromNow(map[<span class="string">&quot;last_reply_at&quot;</span>]),</span><br><span class="line">    <span class="keyword">this</span>.replyCount = map[<span class="string">&quot;reply_count&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.visitCount = map[<span class="string">&quot;visit_count&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.top = map[<span class="string">&quot;top&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.isCollect = map[<span class="string">&quot;is_collect&quot;</span>],</span><br><span class="line">    <span class="keyword">this</span>.replies = formatedReplies(map[<span class="string">&#x27;replies&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/reducer/topic.dart</code>, 通过主题列表的 reducer 来变更 store 里面的数据状态</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Reducer&lt;<span class="built_in">Map</span>&gt; topicsReducer = combineReducers([</span><br><span class="line">  <span class="comment">// 通过指定 action 类型来拆分</span></span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, ClearTopic&gt;(_clearTopic),</span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, RequestTopics&gt;(_requestTopics),</span><br><span class="line">  <span class="keyword">new</span> TypedReducer&lt;<span class="built_in">Map</span>, ResponseTopics&gt;(_responseTopics)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空主题列表</span></span><br><span class="line"><span class="built_in">Map</span> _clearTopic(<span class="built_in">Map</span> state, ClearTopic action) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span> _requestTopics(<span class="built_in">Map</span> state, RequestTopics action) &#123;</span><br><span class="line">  <span class="built_in">Map</span> topicsOfTopics = &#123;&#125;;</span><br><span class="line">  state.forEach((k, v) &#123;</span><br><span class="line">    <span class="keyword">final</span> _v = <span class="keyword">new</span> <span class="built_in">Map</span>.from(v);</span><br><span class="line">    <span class="keyword">if</span> (action.category == k) &#123;</span><br><span class="line">      <span class="comment">// 通过 isFetched 标志位来防止分类页面切换时重复请求</span></span><br><span class="line">      _v[<span class="string">&quot;isFetched&quot;</span>] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    topicsOfTopics[k] = _v;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> topicsOfTopics;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span> _responseTopics(<span class="built_in">Map</span> state, ResponseTopics action) &#123;</span><br><span class="line">  <span class="built_in">Map</span> topicsOfCategory = &#123;&#125;;</span><br><span class="line">  state.forEach((k, v) &#123;</span><br><span class="line">    <span class="built_in">Map</span> _v = &#123;&#125;;</span><br><span class="line">    _v.addAll(v);</span><br><span class="line">    <span class="keyword">if</span> (k == action.category) &#123;</span><br><span class="line">      <span class="built_in">List</span> _list = [];</span><br><span class="line">      <span class="comment">// 上拉加载更多时</span></span><br><span class="line">      <span class="keyword">if</span> (_v[<span class="string">&#x27;currentPage&#x27;</span>] &lt; action.currentPage) &#123;</span><br><span class="line">        _list.addAll(_v[<span class="string">&quot;list&quot;</span>]);</span><br><span class="line">        _list.addAll(action.topics);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">// 下拉刷新时</span></span><br><span class="line">      <span class="keyword">if</span> (action.currentPage == <span class="number">1</span>) &#123;</span><br><span class="line">        _list.addAll(action.topics);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 通过 isFetched 标志位来防止分类页面切换时重复请求</span></span><br><span class="line">      _v[<span class="string">&quot;isFetched&quot;</span>] = <span class="keyword">true</span>;</span><br><span class="line">      _v[<span class="string">&quot;list&quot;</span>] = _list;</span><br><span class="line">      _v[<span class="string">&quot;currentPage&quot;</span>] = action.currentPage;</span><br><span class="line">    &#125;</span><br><span class="line">    topicsOfCategory[k] = _v;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> topicsOfCategory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>store/reducer/root.dart</code> 的 rootReducer 里进行合并</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RootState rootReducer(RootState state, action) &#123;</span><br><span class="line">  <span class="comment">// 处理从持久化存储里加载数据状态</span></span><br><span class="line">  <span class="keyword">if</span> (action <span class="keyword">is</span> PersistLoadedAction&lt;RootState&gt;) &#123;</span><br><span class="line">    <span class="keyword">return</span> action.state ?? state;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 state 里的数据状态对应到子 reducer</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RootState(</span><br><span class="line">    tabIndex: tabReducer(state.tabIndex, action),</span><br><span class="line">    auth:  loginReducer(state.auth, action),</span><br><span class="line">    isLoading: loadingReducer(state.isLoading, action),</span><br><span class="line">    topicsOfCategory: topicsReducer(state.topicsOfCategory, action),</span><br><span class="line">    topic: topicReducer(state.topic, action),</span><br><span class="line">    me: meReducer(state.me, action),</span><br><span class="line">    collects: collectsReducer(state.collects, action),</span><br><span class="line">    messages: messagesReducer(state.messages, action)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store/index.dart</code> store 的初始化入口,在我们上面的入口widget里面使用 <code>StoreProvider</code> 容器包裹的时候传递</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并 epic 获得根 epic 提供给 epic 中间件调用</span></span><br><span class="line"><span class="keyword">final</span> epic = combineEpics([</span><br><span class="line">  doLoginEpic, </span><br><span class="line">  fetchTopicsEpic, fetchTopicEpic, </span><br><span class="line">  fetchMeEpic,</span><br><span class="line">  fetchCollectsEpic,</span><br><span class="line">  fetchMessagesEpic,</span><br><span class="line">  fetchMessageCountEpic,</span><br><span class="line">  markAllAsReadEpic,</span><br><span class="line">  markAsReadEpic,</span><br><span class="line">  createReplyEpic,</span><br><span class="line">  saveTopicEpic,</span><br><span class="line">  createTopicEpic,</span><br><span class="line">  toggleCollectEpic,</span><br><span class="line">  likeReplyEpic,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化持久化中间件存储容器</span></span><br><span class="line"><span class="keyword">final</span> persistor = Persistor&lt;RootState&gt;(</span><br><span class="line">  storage: FlutterStorage(<span class="string">&#x27;cnoder&#x27;</span>),</span><br><span class="line">  decoder: RootState.fromJson,</span><br><span class="line">  debug: <span class="keyword">true</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 store</span></span><br><span class="line"><span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;RootState&gt;(rootReducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> RootState(), middleware: [</span><br><span class="line">    <span class="keyword">new</span> LoggingMiddleware.printer(), </span><br><span class="line">    <span class="keyword">new</span> EpicMiddleware(epic),</span><br><span class="line">    persistor.createMiddleware()</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>这里有个小坑,持久化存储中间件 redux_persist 的文档上加载中间件的方式为</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> store = <span class="keyword">new</span> Store&lt;AppState&gt;(</span><br><span class="line">  reducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> AppState(),</span><br><span class="line">  middleware: [persistor.createMiddleware()],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>但是这样处理的话,在每个业务 action 触发的时候,都会触发持久化的操作,而这在很多场景下是不必要的,比如在我们的应用中只需要保存的用户身份令牌,所以只需要在触发登陆和登出 action 的时候执行持久化的操作,因此加载中间件的方式需要做如下改动</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> persistMiddleware(Store store, <span class="built_in">dynamic</span> action, NextDispatcher next) &#123;</span><br><span class="line">  next(action);</span><br><span class="line">  <span class="comment">// 仅处理登陆和登出操作</span></span><br><span class="line">  <span class="keyword">if</span> (action <span class="keyword">is</span> FinishLogin || action <span class="keyword">is</span> Logout) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      persistor.save(store);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 store</span></span><br><span class="line"><span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;RootState&gt;(rootReducer,</span><br><span class="line">  initialState: <span class="keyword">new</span> RootState(), middleware: [</span><br><span class="line">    <span class="keyword">new</span> LoggingMiddleware.printer(), </span><br><span class="line">    <span class="keyword">new</span> EpicMiddleware(epic),</span><br><span class="line">    persistMiddleware</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h2 id="更多-1"><a href="#更多-1" class="headerlink" title="更多"></a>更多</h2><p>应用的视图层和数据状态处理还是跟使用 React-Native 开发中使用 redux 技术栈的方式差不多,虽然整体目录结构有点繁琐,但是业务逻辑清晰明了,在后续功能扩展和维护的时候还是带来不少的方便,唯一遗憾的是因为 flutter 系统架构的问题,还没有一个针对 flutter 的 redux devtools,这一点还是蛮影响开发效率的</p>
<p>完整的项目源码请关注github仓库: <a target="_blank" rel="noopener" href="https://github.com/ali322/cnoder">cnoder</a>,欢迎 star 和 PR,对 flutter 理解的不深,还望各位对本文中的不足之处批评指正</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Flutter/" rel="tag"># Flutter</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/07/13/nva/" rel="prev" title="nva 简洁高效的前端项目脚手架">
                  <i class="fa fa-chevron-left"></i> nva 简洁高效的前端项目脚手架
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/08/15/reed/" rel="next" title="Reed 基于miniflux的RSS应用">
                  Reed 基于miniflux的RSS应用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ali Chen</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="disqus" type="application/json">{&quot;enable&quot;:true,&quot;shortname&quot;:&quot;alilab&quot;,&quot;count&quot;:true,&quot;i18n&quot;:{&quot;disqus&quot;:&quot;disqus&quot;}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
